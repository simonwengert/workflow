
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ORCA: all parallelisation options &#8212; workflow  documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Parallelize MACE calculator" href="examples.mace.html" />
    <link rel="prev" title="Generating Dimer Structures" href="examples.dimers.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">workflow  documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Contents:
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="first_example.html">
   First example
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="overview.html">
   Overview
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="overview.configset.html">
     Input and output of atomic structures
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="overview.parallelisation.html">
     Automatic parallelization of tasks
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="operations.html">
   Operations
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="operations.calculators.html">
     Calculators in workflow
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="operations.generate.html">
     Generating Configs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="operations.select.html">
     Selecting Configs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="operations.descriptors.html">
     Descriptors
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="operations.gap_fitting.html">
     Fitting GAP
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="operations.multistage_gap_fitting.html">
     Multistage GAP fitting
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="operations.ace_fitting.html">
     ACE fitting
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="operations.utils.html">
     Utility functions
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="workflows.html">
   Workflows
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="workflows.rss.html">
     How to do GAP-RSS
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="workflows.mlip_fitting.html">
     Fitting a MLIP
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="examples.html">
   Examples
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="examples.dimers.html">
     Generating Dimer Structures
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     ORCA: all parallelisation options
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="examples.mace.html">
     Parallelize MACE calculator
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="examples.normal_modes.html">
     Normal Modes (non-periodic)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="examples.smiles.html">
     SMILES to .xyz
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="examples.autopara.html">
     Customise Auto-parallelized Functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="examples.md.html">
     MD
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="modules.html">
   Modules
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="wfl.html">
     wfl package
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
    <label for="toctree-checkbox-6">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="wfl.autoparallelize.html">
       wfl.autoparallelize package
      </a>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="wfl.calculators.html">
       wfl.calculators package
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
      <label for="toctree-checkbox-7">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="wfl.calculators.orca.html">
         wfl.calculators.orca package
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="wfl.cli.html">
       wfl.cli package
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="wfl.descriptors.html">
       wfl.descriptors package
      </a>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="wfl.fit.html">
       wfl.fit package
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
      <label for="toctree-checkbox-8">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="wfl.fit.gap.html">
         wfl.fit.gap package
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="wfl.fit.modify_database.html">
         wfl.fit.modify_database package
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="wfl.generate.html">
       wfl.generate package
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="wfl.scripts.html">
       wfl.scripts package
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="wfl.select.html">
       wfl.select package
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="wfl.utils.html">
       wfl.utils package
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/examples.orca.md.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluate-atomic-configurations-sequentially-on-a-single-core">
   1. Evaluate atomic configurations sequentially on a single core
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#parallelise-with-orca">
   2.1 Parallelise with ORCA
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#parallelise-with-workflow">
   2.2 Parallelise with Workflow
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#parallelise-with-orca-and-workflow">
   2.3 Parallelise with ORCA and Workflow
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluate-structures-in-multiple-queued-jobs">
   3. Evaluate structures in multiple queued jobs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#complete-script">
   4. Complete script
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#config-json-example">
   config.json example
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#another-complete-example">
   Another complete example
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>ORCA: all parallelisation options</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluate-atomic-configurations-sequentially-on-a-single-core">
   1. Evaluate atomic configurations sequentially on a single core
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#parallelise-with-orca">
   2.1 Parallelise with ORCA
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#parallelise-with-workflow">
   2.2 Parallelise with Workflow
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#parallelise-with-orca-and-workflow">
   2.3 Parallelise with ORCA and Workflow
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluate-structures-in-multiple-queued-jobs">
   3. Evaluate structures in multiple queued jobs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#complete-script">
   4. Complete script
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#config-json-example">
   config.json example
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#another-complete-example">
   Another complete example
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <div class="section" id="orca-all-parallelisation-options">
<h1>ORCA: all parallelisation options<a class="headerlink" href="#orca-all-parallelisation-options" title="Permalink to this headline">#</a></h1>
<div class="section" id="evaluate-atomic-configurations-sequentially-on-a-single-core">
<h2>1. Evaluate atomic configurations sequentially on a single core<a class="headerlink" href="#evaluate-atomic-configurations-sequentially-on-a-single-core" title="Permalink to this headline">#</a></h2>
<p>The following command will evaluate <code class="docutils literal notranslate"><span class="pre">configs.xyz</span></code> with the ORCA DFT code. The Workflow code called with <code class="docutils literal notranslate"><span class="pre">wfl</span> <span class="pre">ref-method</span> <span class="pre">orca-eval</span> <span class="pre">...</span> </code> is an extension of the <a class="reference external" href="https://wiki.fysik.dtu.dk/ase/ase/calculators/orca.html#module-ase.calculators.orca">ASE ORCA calculator</a>. The extended calculator automates file handling: each structure is evaluated in a separate directory and only specified files are kept.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>base_rundir=orca_base_rundir
orca_simple_input=&quot;UKS B3LYP def2-SV(P) def2/J D3BJ&quot;
orca_additional_blocks=&quot;%scf Convergence Tight SmearTemp 5000 end &quot;
output_prefix=&#39;dft_&#39;
orca_command=&quot;/opt/womble/orca/orca_5.0.0/orca&quot;
tmp_dir=/scratch-ssd/my_dir_on_scratch
mkdir -p $tmp_dir

input=&quot;configs.xyz&quot;
output=&quot;configs.dft.xyz&quot;

wfl -v ref-method orca-eval -tmp ${tmp_dir} --base-rundir $base_rundir --output-prefix &quot;${output_prefix}&quot; 
                            --orca-simple-input &quot;${orca_simple_input}&quot; --orca-additional-blocks &quot;${orca_additional_blocks}&quot; 
                            --orca-command &quot;${orca_command}&quot; --output-file $output --keep-files default $input
</pre></div>
</div>
<p>The parameters are</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">base_rundir</span></code> - this directory is where directories for each separate DFT calculation will be based.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">orca_simple_input</span></code> - <a class="reference external" href="https://sites.google.com/site/orcainputlibrary/general-input?authuser=0#h.rafay5vzyzkw">ORCA simple input</a> line, prepended with <code class="docutils literal notranslate"><span class="pre">!</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">orca_additional_blocks</span></code> - <a class="reference external" href="https://sites.google.com/site/orcainputlibrary/general-input?authuser=0#h.k0jcjw8bcgcx">ORCA block input</a>, the rest of ORCA input file, excluding the coordinate definition.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">output_prefix</span></code> - prefix to the results’ keys in <code class="docutils literal notranslate"><span class="pre">atoms.info</span></code> and <code class="docutils literal notranslate"><span class="pre">atoms.arrays</span></code>. Here DFT results will be saved to <code class="docutils literal notranslate"><span class="pre">dft_energy</span></code>, <code class="docutils literal notranslate"><span class="pre">dft_forces</span></code> and <code class="docutils literal notranslate"><span class="pre">dft_dipole</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">orca_command</span></code> - path to ORCA executable.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tmp_dir</span></code> - directory on a SSD for more efficient calculations.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">input</span></code> - <code class="docutils literal notranslate"><span class="pre">.xyz</span></code> file to be evaluated.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">output</span></code> - <code class="docutils literal notranslate"><span class="pre">.xyz</span></code> to save configs with results to. This command will refuse to overwrite if the file exists.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--keep-files</span> <span class="pre">default</span></code> - only <code class="docutils literal notranslate"><span class="pre">.inp</span></code>, <code class="docutils literal notranslate"><span class="pre">.out</span></code>, <code class="docutils literal notranslate"><span class="pre">.ase</span></code>, <code class="docutils literal notranslate"><span class="pre">.engrad</span></code>, <code class="docutils literal notranslate"><span class="pre">.xyz</span></code> and <code class="docutils literal notranslate"><span class="pre">_trj.xyz</span></code> files will be saved, where applicable, upon success. All files will be kept if the calculation failed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">wfl</span> <span class="pre">-v</span> <span class="pre">ref-method</span> <span class="pre">orca-eval</span></code> - Workflow command to evaluate DFT, in verbose mode.</p></li>
</ul>
<p>With this command each structure will be evaluated sequentially on a single core.</p>
</div>
<div class="section" id="parallelise-with-orca">
<h2>2.1 Parallelise with ORCA<a class="headerlink" href="#parallelise-with-orca" title="Permalink to this headline">#</a></h2>
<p>Changing the simple input to <code class="docutils literal notranslate"><span class="pre">orca_simple_input=&quot;UKS</span> <span class="pre">B3LYP</span> <span class="pre">def2-SV(P)</span> <span class="pre">def2/J</span> <span class="pre">D3BJ</span> <span class="pre">PAL8&quot;</span></code> will turn on <a class="reference external" href="https://sites.google.com/site/orcainputlibrary/setting-up-orca#h.p0hdj6lom1lz">ORCA’s parallelsation</a>. This command will still evaluate all structures in <code class="docutils literal notranslate"><span class="pre">config.xyz</span></code> in sequence, but each evaluation will use 8 cores and MPI within ORCA (no need to <code class="docutils literal notranslate"><span class="pre">mpirun</span> <span class="pre">-np</span> <span class="pre">8</span> <span class="pre">orca</span></code>)</p>
</div>
<div class="section" id="parallelise-with-workflow">
<h2>2.2 Parallelise with Workflow<a class="headerlink" href="#parallelise-with-workflow" title="Permalink to this headline">#</a></h2>
<p>Alternatively, it might be more useful to run ORCA itself sequentially (<code class="docutils literal notranslate"><span class="pre">orca_simple_input=&quot;UKS</span> <span class="pre">B3LYP</span> <span class="pre">def2-SV(P)</span> <span class="pre">def2/J</span> <span class="pre">D3BJ&quot;</span></code>), but use Workflow to evaluate multiple structures at the same time in parallel. For that, <code class="docutils literal notranslate"><span class="pre">WFL_NUM_PYTHON_SUBPROCESSES</span></code> should be set to the number of processes to use (e.g. <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">WFL_NUM_PYTHON_SUBPROCESSES=8</span></code>). (N.B. as a rule of thumb, <code class="docutils literal notranslate"><span class="pre">OMP_NUM_THREADS</span></code> must be set to <code class="docutils literal notranslate"><span class="pre">1</span></code>).</p>
</div>
<div class="section" id="parallelise-with-orca-and-workflow">
<h2>2.3 Parallelise with ORCA and Workflow<a class="headerlink" href="#parallelise-with-orca-and-workflow" title="Permalink to this headline">#</a></h2>
<p>Mixed-mode parallelisation is not supported or tested and should be avoided. We expect that the two cases above should cover practically all of the use-cases.</p>
</div>
<div class="section" id="evaluate-structures-in-multiple-queued-jobs">
<h2>3. Evaluate structures in multiple queued jobs<a class="headerlink" href="#evaluate-structures-in-multiple-queued-jobs" title="Permalink to this headline">#</a></h2>
<p>The parallelisation steps described above would normally be done as a “queued job” on a cluster. Workflow allows for the input configurations’ file to be chopped up and submitted as a separate jobs (possibly using parallelisation within each job) allowing for an even more efficient parallelisation.</p>
<p>First, one need a configuration (<code class="docutils literal notranslate"><span class="pre">config.json</span></code>) that specifies what “resources” are avaliable on the “local” cluster/machine/queue. For explanation of what means what see …</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="s2">&quot;systems&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;local&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
        <span class="s2">&quot;scheduler&quot;</span><span class="p">:</span> <span class="s2">&quot;sge&quot;</span><span class="p">,</span>
        <span class="s2">&quot;commands&quot;</span><span class="p">:</span> <span class="p">[</span>  <span class="s2">&quot;echo $(date)&quot;</span><span class="p">,</span> <span class="s2">&quot;hostname&quot;</span><span class="p">],</span>
        <span class="s2">&quot;header&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;#$ -pe smp </span><span class="si">{num_cores_per_node}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="s2">&quot;rundir&quot;</span><span class="p">:</span> <span class="s2">&quot;/data/eg475/run_expyre&quot;</span><span class="p">,</span>
        <span class="s2">&quot;partitions&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;any&quot;</span><span class="p">:</span>        <span class="p">{</span><span class="s2">&quot;num_cores&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> <span class="s2">&quot;max_time&quot;</span><span class="p">:</span> <span class="s2">&quot;168h&quot;</span><span class="p">,</span> <span class="s2">&quot;max_mem&quot;</span><span class="p">:</span> <span class="s2">&quot;50GB&quot;</span><span class="p">},</span>
                       <span class="s2">&quot;any@node15&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;num_cores&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="s2">&quot;max_time&quot;</span><span class="p">:</span> <span class="s2">&quot;168h&quot;</span><span class="p">,</span> <span class="s2">&quot;max_mem&quot;</span><span class="p">:</span> <span class="s2">&quot;47GB&quot;</span><span class="p">},</span>
                    <span class="p">}</span>
            <span class="p">}</span>
<span class="p">}}</span>
</pre></div>
</div>
<p>For a job to run remotely, one needs to specify a “remote info” dictionary:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">remote_ifno</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;orca.py::evaluate&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;sys_name&quot;</span><span class="p">:</span> <span class="s2">&quot;local&quot;</span><span class="p">,</span>
        <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;dft&quot;</span><span class="p">,</span>
        <span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;num_cores&quot;</span> <span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;partitions&quot;</span><span class="p">:</span><span class="s2">&quot;any$&quot;</span><span class="p">,</span> <span class="s2">&quot;max_time&quot;</span><span class="p">:</span> <span class="s2">&quot;4h&quot;</span><span class="p">},</span>
        <span class="s2">&quot;partial_node&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">,</span>
        <span class="s2">&quot;num_inputs_per_queued_job&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}}</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">orca.py::evaluate</span></code> - the signature of the function which should be parallelised by submitting multiple queued jobs. Scripts might have multiple functions that can be parallelised like this and it might make sense to only do that to some of them.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sys_name</span></code> - queue/system/cluster name to execute the job on. One fo the entries in <code class="docutils literal notranslate"><span class="pre">config.json</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">job_name</span></code> - prefix for the job’s name on the queue (converted to <code class="docutils literal notranslate"><span class="pre">#$</span> <span class="pre">-N</span></code> bit of the header on SGE).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">resources</span></code> - how many resources the job should require from the queue.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;num_cores&quot;:</span> <span class="pre">4</span></code> - ask for 4 cores. That’s executed by <code class="docutils literal notranslate"><span class="pre">&quot;header&quot;:</span> <span class="pre">[&quot;#$</span> <span class="pre">-pe</span> <span class="pre">smp</span> <span class="pre">{num_cores_per_node}&quot;]</span></code> of <code class="docutils literal notranslate"><span class="pre">config.json</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">partitions</span></code> - name of the queue, converted to <code class="docutils literal notranslate"><span class="pre">#$</span> <span class="pre">-q</span> <span class="pre">any</span></code> in this example that uses SGE. ExPyRe uses RegEx to find matching partition names, so <code class="docutils literal notranslate"><span class="pre">any$</span></code> will only pick the first of the two partitions specified in <code class="docutils literal notranslate"><span class="pre">config.json</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_time</span></code> - time requirement for the job, converted to <code class="docutils literal notranslate"><span class="pre">#$</span> <span class="pre">-l</span> <span class="pre">h_rt=4:00:00</span></code> in this example.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">partial_node</span></code> - assumes that the que works in “node non-exclusive” way, multiple jobs may be run on a given node and allows picking a partition (<code class="docutils literal notranslate"><span class="pre">any</span></code> in this case) even if it has more cores available (32 here) than the number of cores needed for the job (4 in this case).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_inputs_per_queued_job</span></code> - how many structures to assign to a single queued job.</p></li>
</ul>
</div>
<div class="section" id="complete-script">
<h2>4. Complete script<a class="headerlink" href="#complete-script" title="Permalink to this headline">#</a></h2>
<p>Let us assume 100 structures in the <code class="docutils literal notranslate"><span class="pre">configs.xyz</span></code> file. Put together, this script will create 5 separate 4-core jobs (<code class="docutils literal notranslate"><span class="pre">100/num_inputs_per_queued_job</span></code>) with 20 atomic structures assigned to each. Within a given job, the configs will be evaluated 4 at a time (i.e. <code class="docutils literal notranslate"><span class="pre">WFL_NUM_PYTHON_SUBPROCESSES</span></code> will be <em>automatically</em> set to <code class="docutils literal notranslate"><span class="pre">4</span></code>), each ORCA comman running in serial.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>export WFL_EXPYRE_INFO=$PWD/remoteinfo.json
cat &lt;&lt;EOF &gt; remoteinfo.json
{
&quot;orca.py::evaluate&quot; : {
    &quot;sys_name&quot;: &quot;local&quot;,
    &quot;job_name&quot;: &quot;dft&quot;,
    &quot;resources&quot;: {&quot;num_cores&quot; : 4, &quot;partitions&quot;:&quot;any$&quot;, &quot;max_time&quot;: &quot;4h&quot;},
    &quot;partial_node&quot;:true,
    &quot;num_inputs_per_queued_job&quot;: 20}
}
EOF

mkdir -p _expyre

base_rundir=orca_base_rundir
orca_simple_input=&quot;UKS B3LYP def2-SV(P) def2/J D3BJ&quot;
orca_additional_blocks=&quot;%scf Convergence Tight SmearTemp 5000 end &quot;
output_prefix=&#39;dft_&#39;
orca_command=&quot;/opt/womble/orca/orca_5.0.0/orca&quot;
tmp_dir=/scratch-ssd/my_dir_on_scratch
mkdir -p $tmp_dir

input=&quot;configs.xyz&quot;
output=&quot;configs.dft.xyz&quot;

wfl -v ref-method orca-eval -tmp ${tmp_dir} --base-rundir $base_rundir --output-prefix &quot;${output_prefix}&quot; 
                            --orca-simple-input &quot;${orca_simple_input}&quot; --orca-additional-blocks &quot;${orca_additional_blocks}&quot; 
                            --orca-command &quot;${orca_command}&quot; --output-file $output --keep-files default $input
</pre></div>
</div>
</div>
<div class="section" id="config-json-example">
<h2>config.json example<a class="headerlink" href="#config-json-example" title="Permalink to this headline">#</a></h2>
<p>Below is an example of corresponding <code class="docutils literal notranslate"><span class="pre">config.json</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="p">{</span> <span class="s2">&quot;systems&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;local&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
            <span class="s2">&quot;scheduler&quot;</span><span class="p">:</span> <span class="s2">&quot;sge&quot;</span><span class="p">,</span>
            <span class="s2">&quot;commands&quot;</span><span class="p">:</span> <span class="p">[</span>  <span class="s2">&quot;echo $(date)&quot;</span><span class="p">,</span> <span class="s2">&quot;hostname&quot;</span><span class="p">],</span>
            <span class="s2">&quot;header&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;#$ -pe smp </span><span class="si">{num_cores_per_node}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="s2">&quot;rundir&quot;</span><span class="p">:</span> <span class="s2">&quot;/data/eg475/run_expyre&quot;</span><span class="p">,</span>
            <span class="s2">&quot;partitions&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;any&quot;</span><span class="p">:</span>        <span class="p">{</span><span class="s2">&quot;num_cores&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> <span class="s2">&quot;max_time&quot;</span><span class="p">:</span> <span class="s2">&quot;168h&quot;</span><span class="p">,</span> <span class="s2">&quot;max_mem&quot;</span><span class="p">:</span> <span class="s2">&quot;50GB&quot;</span><span class="p">},</span>
                           <span class="s2">&quot;any@node15&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;num_cores&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="s2">&quot;max_time&quot;</span><span class="p">:</span> <span class="s2">&quot;168h&quot;</span><span class="p">,</span> <span class="s2">&quot;max_mem&quot;</span><span class="p">:</span> <span class="s2">&quot;47GB&quot;</span><span class="p">},</span>
                        <span class="p">}</span>
                <span class="p">}</span>
    <span class="p">}}</span>
</pre></div>
</div>
</div>
<div class="section" id="another-complete-example">
<h2>Another complete example<a class="headerlink" href="#another-complete-example" title="Permalink to this headline">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">wfl.configset</span> <span class="kn">import</span> <span class="n">ConfigSet</span><span class="p">,</span> <span class="n">OutputSpec</span>
<span class="kn">from</span> <span class="nn">wfl.calculators.orca</span> <span class="kn">import</span> <span class="n">ORCA</span><span class="p">,</span> <span class="n">natural_population_analysis</span>
<span class="kn">import</span> <span class="nn">util</span>
<span class="kn">from</span> <span class="nn">util.util_config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">wfl.calculators</span> <span class="kn">import</span> <span class="n">generic</span>
<span class="kn">import</span> <span class="nn">wfl.autoparallelize.remoteinfo</span>
<span class="kn">from</span> <span class="nn">expyre.resources</span> <span class="kn">import</span> <span class="n">Resources</span>

<span class="n">input_fname</span> <span class="o">=</span> <span class="s2">&quot;validation.rdkit.xtb2_md.dft.both.xyz&quot;</span>
<span class="n">output_fname</span> <span class="o">=</span> <span class="s2">&quot;validation.rdkit.xtb2_md.dft.both.dft.xyz&quot;</span>
<span class="n">num_inputs_per_queued_job</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">num_cores</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">max_time</span> <span class="o">=</span> <span class="s2">&quot;48h&quot;</span>

<span class="c1"># structures</span>
<span class="n">ci</span> <span class="o">=</span> <span class="n">ConfigSet</span><span class="p">(</span><span class="n">input_fname</span><span class="p">)</span>
<span class="n">co</span> <span class="o">=</span> <span class="n">OutputSpec</span><span class="p">(</span><span class="n">output_fname</span><span class="p">)</span>

<span class="n">expyre_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;_expyre&quot;</span><span class="p">)</span>
<span class="n">expyre_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># remote info</span>
<span class="n">resources</span> <span class="o">=</span> <span class="n">Resources</span><span class="p">(</span>
    <span class="n">max_time</span> <span class="o">=</span> <span class="n">max_time</span><span class="p">,</span>
    <span class="n">num_cores</span> <span class="o">=</span> <span class="n">num_cores</span><span class="p">,</span>
    <span class="n">partitions</span> <span class="o">=</span> <span class="s2">&quot;any$&quot;</span><span class="p">)</span>

<span class="n">remote_info</span> <span class="o">=</span> <span class="n">wfl</span><span class="o">.</span><span class="n">autoparallelize</span><span class="o">.</span><span class="n">remoteinfo</span><span class="o">.</span><span class="n">RemoteInfo</span><span class="p">(</span>
    <span class="n">sys_name</span> <span class="o">=</span> <span class="s2">&quot;local&quot;</span><span class="p">,</span> 
    <span class="n">job_name</span> <span class="o">=</span> <span class="s2">&quot;npa&quot;</span><span class="p">,</span> 
    <span class="n">resources</span> <span class="o">=</span> <span class="n">resources</span><span class="p">,</span> 
    <span class="n">partial_node</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
    <span class="n">num_inputs_per_queued_job</span><span class="o">=</span><span class="n">num_inputs_per_queued_job</span><span class="p">,</span> 
    <span class="n">output_files</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ORCA_calc_files&quot;</span><span class="p">])</span>

<span class="c1"># orca params</span>
<span class="n">orca_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;orcablocks&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">cf Convergence Tight SmearTemp 5000 end&quot;</span><span class="p">,</span>
               <span class="s2">&quot;orcasimpleinput&quot;</span><span class="p">:</span> <span class="s2">&quot;UKS B3LYP def2-SV(P) def2/J D3BJ&quot;</span><span class="p">}</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;orca_kwargs: </span><span class="si">{</span><span class="n">orca_kwargs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># calculator</span>
<span class="n">keep_files</span> <span class="o">=</span> <span class="kc">False</span> 
<span class="n">janpa_home_dir</span> <span class="o">=</span> <span class="s2">&quot;/home/eg475/programs/janpa&quot;</span> 
<span class="n">post_func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">natural_population_analysis</span><span class="p">,</span> <span class="n">janpa_home_dir</span><span class="p">)</span>
<span class="n">calculator</span> <span class="o">=</span> <span class="p">(</span><span class="n">ORCA</span><span class="p">,</span> <span class="p">[],</span> <span class="p">{</span><span class="o">**</span><span class="p">{</span><span class="s2">&quot;keep_files&quot;</span><span class="p">:</span><span class="n">keep_files</span><span class="p">,</span> <span class="s2">&quot;post_process&quot;</span><span class="p">:</span><span class="n">post_func</span><span class="p">},</span> <span class="o">**</span><span class="n">orca_kwargs</span><span class="p">})</span>

<span class="c1"># run calculation</span>
<span class="n">generic</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">inputs</span><span class="o">=</span><span class="n">ci</span><span class="p">,</span> 
    <span class="n">outputs</span><span class="o">=</span><span class="n">co</span><span class="p">,</span>
    <span class="n">calculator</span><span class="o">=</span><span class="n">calculator</span><span class="p">,</span>
    <span class="n">properties</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="s2">&quot;forces&quot;</span><span class="p">],</span>
    <span class="n">output_prefix</span><span class="o">=</span><span class="s1">&#39;dft_&#39;</span><span class="p">,</span>
    <span class="n">remote_info</span><span class="o">=</span><span class="n">remote_info</span><span class="p">,</span>
	<span class="n">num_inputs_per_python_subprocess</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>



</pre></div>
</div>
</div>
</div>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="examples.dimers.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Generating Dimer Structures</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="examples.mace.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Parallelize MACE calculator</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By N. Bernstein, T. K. Stenczel, E. Gelzinyte<br/>
  
      &copy; Copyright .<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>